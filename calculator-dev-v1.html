<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Calculator</title>
    <!-- Font Awesome for caret icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Embedded CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c2c2c;
            color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 15px;
            box-sizing: border-box;
        }

        .main-container {
            width: 100%;
            max-width: 1200px;
        }

        /* --- Tab Navigation --- */
        .tab-navigation {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid #555;
        }

        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #3b3b3b;
            border: none;
            color: #ccc;
            border-radius: 8px 8px 0 0;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }

        .tab-button.active {
            background-color: #555;
            color: #ff9900;
            border-bottom: 2px solid #ff9900;
            margin-bottom: -2px;
        }
        
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* --- Main Layout for Both Tabs --- */
        .main-layout-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            width: 100%;
        }

        .calculator-left-side {
            flex: 0 0 500px;
            max-width: 100%;
            box-sizing: border-box;
        }

        .results-right-side {
            flex: 1;
            min-width: 300px;
            background-color: #3b3b3b;
            border-radius: 10px;
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px; /* COMPACT: Reduced gap */
        }

        .calculator-container {
            background-color: #3b3b3b;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            width: 100%;
            box-sizing: border-box;
        }
        
        /* --- General Input and Button Styles --- */
        .input-group { margin-bottom: 15px; }
        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #ccc;
        }

        input[type="number"], input[type="date"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #4a4a4a;
            color: #f0f0f0;
            font-size: 1em;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-color: #ff9900;
            outline: none;
        }

        .input-with-symbol {
            display: flex;
            align-items: center;
            background-color: #4a4a4a;
            border: 1px solid #555;
            border-radius: 6px;
            padding-left: 10px;
        }
        .input-with-symbol span { color: #ccc; margin-right: 8px; }
        .input-with-symbol input { border: none; background: transparent; flex-grow: 1; padding-left: 0; }

        .currency-selector { display: flex; gap: 8px; flex-wrap: wrap; }
        .currency-button {
            padding: 8px 12px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #4a4a4a;
            color: #ccc;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .currency-button.active { background-color: #ff9900; border-color: #ff9900; color: #fff; }

        .rate-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #4a4a4a;
            border: 1px solid #555;
            border-radius: 6px;
            padding: 0 10px;
        }
        .rate-input-group input, .rate-input-group select {
            border: none;
            background: transparent;
            flex-grow: 1;
            width: auto;
            padding: 10px 0;
        }
        .rate-input-group .rate-period-label { color: #ccc; font-size: 0.9em; white-space: nowrap; margin-left: 5px; }

        .static-reinvest-rate { color: #f0f0f0; font-weight: bold; padding: 10px 0; display: flex; align-items: center; flex-grow: 1; white-space: nowrap; }
        .static-reinvest-rate .rate-period-label { color: #ccc; font-size: 0.9em; margin-left: 5px; }

        .calculate-button {
            width: 100%;
            padding: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 15px;
        }
        .calculate-button:hover { background-color: #45a049; }

        .remember-data-group { display: flex; align-items: center; margin: 15px 0 20px 0; }
        .remember-data-group label { margin-bottom: 0; font-size: 1em; cursor: pointer; }
        .remember-data-group input[type="checkbox"] {
            width: auto; margin-right: 10px; transform: scale(1.2); -webkit-appearance: none; -moz-appearance: none;
            appearance: none; border: 2px solid #ff9900; border-radius: 4px; height: 18px; width: 18px;
            background-color: #4a4a4a; cursor: pointer; position: relative;
        }
        .remember-data-group input[type="checkbox"]:checked { background-color: #ff9900; border-color: #ff9900; }
        .remember-data-group input[type="checkbox"]:checked::after {
            content: '✔'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #3b3b3b; font-size: 14px; line-height: 1;
        }

        .message-box {
            background-color: #dc3545; color: white; padding: 10px 15px; border-radius: 5px;
            margin-bottom: 15px; text-align: center; opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .message-box.show { opacity: 1; }

        /* --- Results Section Styles --- */
        .results-section h2, .results-section h3 {
            color: #ff9900; font-weight: bold; margin-bottom: 10px;
            padding-bottom: 0; border-bottom: none;
        }
        .results-section h2 { font-size: 1.6em; }
        .results-section h3 { font-size: 1.4em; }

        .results-divider { border: none; border-top: 1px solid #555; margin: 10px 0 10px 0; } /* COMPACT: Reduced margin */

        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px 15px; align-items: baseline; } /* COMPACT: Reduced gap */
        .grid-item { display: flex; flex-direction: column; margin-bottom: 5px; } /* COMPACT: Added margin-bottom */
        .grid-item .result-label { font-size: 0.85em; color: #aaa; margin-bottom: 2px; } 
        .grid-item .result-value { font-size: 1.3em; font-weight: bold; color: #f0f0f0; margin-top: 0; }
        
        .result-value.green { color: #4CAF50; }
        .result-value.orange { color: #ff9900; }
        .result-value.blue { color: #2196F3; }
        .right-align { text-align: right; }

        .initial-balance { margin-top: 10px; text-align: right; } /* COMPACT: Reduced margin */
        .initial-balance .result-label { font-size: 0.85em; color: #aaa; margin-bottom: 2px; } 

        /* --- Expandable Breakdown Styles --- */
        .expandable-section { margin-top: 0; background-color: #2b2b2b; border-radius: 8px; overflow: hidden; padding: 8px 15px; } /* COMPACT: Reduced padding */
        .toggle-breakdown-btn {
            width: 100%; background: transparent; color: #ff9900; border: none; padding: 8px 0;
            font-size: 1em; font-weight: bold; text-align: left; cursor: pointer; display: flex;
            justify-content: space-between; align-items: center; transition: color 0.2s ease;
        }
        .toggle-breakdown-btn:hover { color: #ffa52a; }
        .toggle-breakdown-btn i { transition: transform 0.3s ease; }
        .toggle-breakdown-btn.expanded i { transform: rotate(180deg); }

        .breakdown-content {
            max-height: 0; overflow-y: auto; transition: max-height 0.5s ease-out, padding 0.5s ease-out;
            padding: 0; color: #f0f0f0; font-size: 0.9em;
        }
        .breakdown-content.expanded { max-height: 400px; padding-top: 10px; padding-bottom: 5px; }

        .breakdown-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        .breakdown-table th, .breakdown-table td { padding: 6px 8px; text-align: right; border-bottom: 1px solid #4a4a4a; }
        .breakdown-table thead th {
            background-color: #222; color: #fff; font-weight: normal; font-size: 0.85em;
            border-bottom: 2px solid #555; position: sticky; top: 0; z-index: 1;
        }
        .breakdown-table tbody tr:last-child td { border-bottom: none; }
        .breakdown-table tbody tr:nth-child(even) { background-color: #303030; }
        .breakdown-table td.col-date-day { text-align: left; font-weight: bold; }
        .breakdown-table td.col-total-earnings, .breakdown-table td.col-per-day { color: #ff9900; font-weight: bold; }
        .breakdown-table td.col-balance, .breakdown-table td.col-total-volume { color: #2196F3; font-weight: bold; }

        .no-data { color: #aaa; text-align: center; padding: 10px 0; }
        .small-note { font-size: 0.8em; color: #aaa; margin-top: 8px; line-height: 1.3; }
        
        /* --- Trading Volume Tab Specific --- */
        #tvResults .result-value.large { font-size: 2.5em; color: #4CAF50; }
        #tvResults .grid-item.days-needed { align-items: center; margin-bottom: 10px; } /* COMPACT: Reduced margin */
        .results-section.trading-volume-results { background-color: #2b2b2b; border-radius: 8px; padding: 10px 15px; } /* COMPACT: Reduced padding */
        .results-section.trading-volume-results h3 { color: #ff9900; margin: 0 0 10px 0; }


        /* --- Responsive Styles --- */
        @media (max-width: 950px) {
            .main-layout-container { flex-direction: column; }
        }

        @media (max-width: 600px) {
            body { padding: 0; }
            .main-container { padding: 0; }
            .tab-navigation { margin: 0 10px 10px 10px; }
            .main-layout-container { gap: 0; }
            .calculator-container, .results-right-side {
                padding: 15px; border-radius: 0; margin: 0; box-shadow: none;
            }
            .results-right-side { border-top: 1px solid #444; gap: 10px; }
            .results-grid { grid-template-columns: 1fr; gap: 8px; }
            .grid-item.right-align, .initial-balance { text-align: left; }
            .initial-balance { margin-top: 15px; }
            .expandable-section, .results-section.trading-volume-results { padding: 8px 10px; }

            /* Stacked table for mobile */
            .breakdown-table, .breakdown-table tbody, .breakdown-table tr, .breakdown-table td, .breakdown-table th {
                display: block; width: 100%; text-align: right;
            }
            .breakdown-table thead { display: none; }
            .breakdown-table tr { margin-bottom: 8px; border: 1px solid #4a4a4a; border-radius: 6px; overflow: hidden; }
            .breakdown-table td { border-bottom: 1px dotted #4a4a4a; padding: 6px 10px 6px 50%; position: relative; }
            .breakdown-table td.col-date-day { text-align: right; }
            .breakdown-table td::before {
                content: attr(data-label); position: absolute; left: 10px; width: 45%;
                padding-right: 10px; white-space: nowrap; font-weight: bold; color: #bbb; text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" data-tab="calculationsTab">Calculations</button>
            <button class="tab-button" data-tab="tradingVolumeTab">Trading Volume</button>
        </div>

        <!-- #################### -->
        <!-- CALCULATIONS TAB   -->
        <!-- #################### -->
        <div id="calculationsTab" class="tab-content active">
            <div class="main-layout-container">
                <div class="calculator-left-side">
                    <div class="calculator-container">
                        <div class="input-group">
                            <label for="currency">Currency:</label>
                            <div class="currency-selector" id="currencySelector">
                                <button class="currency-button" data-currency-symbol="USDT">USDT</button>
                                <button class="currency-button" data-currency-symbol="USDC">USDC</button>
                                <button class="currency-button" data-currency-symbol="$">USD</button>
                                <button class="currency-button" data-currency-symbol="€">EUR</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="principal">Principal amount:</label>
                            <div class="input-with-symbol">
                                <span id="principalSymbol">USDT</span>
                                <input type="number" id="principal" value="1000" min="0" data-persist="true" autocomplete="off">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="interestRate">Interest rate:</label>
                            <div class="rate-input-group">
                                <select id="interestRate" data-persist="true">
                                    <option value="1.3" selected>1.3%</option>
                                    <option value="1.95">1.95%</option>
                                    <option value="2.6">2.6%</option>
                                    <option value="3.25">3.25%</option>
                                    <option value="3.9">3.9%</option>
                                </select>
                                <span class="rate-period-label">daily</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="days">Duration:</label>
                            <div class="rate-input-group">
                                <input type="number" id="days" value="30" min="0" data-persist="true" autocomplete="off">
                                <span class="rate-period-label">Days</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Daily reinvest rate</label>
                            <div class="rate-input-group"><span class="static-reinvest-rate">100%</span></div>
                        </div>
                        <div class="input-group">
                            <label>Start date?</label>
                            <input type="date" id="startDate" data-persist="true" autocomplete="off">
                        </div>
                        <div class="input-group remember-data-group">
                            <input type="checkbox" id="rememberDataCheckbox" data-persist="true">
                            <label for="rememberDataCheckbox">Remember data for next time</label>
                        </div>
                        <div id="messageBox" class="message-box"></div>
                        <button class="calculate-button" id="calculateBtn">Calculate</button>
                    </div>
                </div>
                <div class="results-right-side">
                    <div class="results-section">
                        <h2 id="projectionHeading">Projection for 0 days</h2>
                        <hr class="results-divider">
                        <div class="results-grid">
                            <div class="grid-item"><p class="result-label">Investment value</p><p class="result-value green" id="investmentValue">USDT 0.00</p></div>
                            <div class="grid-item right-align"><p class="result-label">Total days</p><p class="result-value" id="totalDaysResult">0</p></div>
                            <div class="grid-item"><p class="result-label">Total interest / earnings</p><p class="result-value orange" id="totalEarnings">USDT 0.00</p></div>
                            <div class="grid-item right-align"><p class="result-label">Daily interest rate</p><p class="result-value" id="dailyEffectiveRate">0.0%</p></div>
                            <div class="grid-item"><p class="result-label">Percentage profit</p><p class="result-value orange" id="percentageProfit">0.0%</p></div>
                            <div class="grid-item right-align"><p class="result-label">End date</p><p class="result-value" id="endDate">Jul 11, 2025</p></div>
                        </div>
                        <div class="initial-balance"><p class="result-label">Initial balance on <span id="initialBalanceDate">Jul 11, 2025</span></p><p class="result-value blue" id="initialBalance">USDT 0.00</p></div>
                    </div>
                    <div class="results-section trading-volume-results">
                        <h3>Trading Volume Results:</h3>
                        <p>Total Trading Volume: <span id="totalTradingVolume">USDT 0.00</span></p>
                        <p class="small-note" id="tradingVolumeNote"></p>
                    </div>
                    <div class="expandable-section">
                        <button class="toggle-breakdown-btn" id="toggleTradingVolumeBreakdownBtn">Trading Volume Breakdown Daily <i class="fas fa-caret-down"></i></button>
                        <div class="breakdown-content" id="tradingVolumeBreakdownContent"><p class="no-data">Calculate first.</p></div>
                    </div>
                    <div class="expandable-section">
                        <button class="toggle-breakdown-btn" id="toggleEarningsBreakdownBtn">Earnings Breakdown Daily <i class="fas fa-caret-down"></i></button>
                        <div class="breakdown-content" id="dailyBreakdownContent"><p class="no-data">Calculate first.</p></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- #################### -->
        <!-- TRADING VOLUME TAB -->
        <!-- #################### -->
        <div id="tradingVolumeTab" class="tab-content">
            <div class="main-layout-container">
                <div class="calculator-left-side">
                    <div class="calculator-container">
                        <div class="input-group">
                            <label>Currency:</label>
                            <div class="currency-selector" id="tvCurrencySelector">
                                <button class="currency-button active" data-currency-symbol="USDT">USDT</button>
                                <button class="currency-button" data-currency-symbol="USDC">USDC</button>
                                <button class="currency-button" data-currency-symbol="$">USD</button>
                                <button class="currency-button" data-currency-symbol="€">EUR</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="tvPrincipal">Principal amount:</label>
                            <div class="input-with-symbol">
                                <span id="tvPrincipalSymbol">USDT</span>
                                <input type="number" id="tvPrincipal" value="1000" min="0" data-persist-tv="true" autocomplete="off">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="tvInterestRate">Interest rate:</label>
                            <div class="rate-input-group">
                                <select id="tvInterestRate" data-persist-tv="true">
                                    <option value="1.3" selected>1.3%</option>
                                    <option value="1.95">1.95%</option>
                                    <option value="2.6">2.6%</option>
                                    <option value="3.25">3.25%</option>
                                    <option value="3.9">3.9%</option>
                                </select>
                                <span class="rate-period-label">daily</span>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="tvTargetVolume">Target trading volume:</label>
                            <div class="input-with-symbol">
                                <span id="tvTargetVolumeSymbol">USDT</span>
                                <input type="number" id="tvTargetVolume" value="1000" min="0" data-persist-tv="true" autocomplete="off">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Start date?</label>
                            <input type="date" id="tvStartDate" data-persist-tv="true" autocomplete="off">
                        </div>
                        <div class="input-group remember-data-group">
                            <input type="checkbox" id="tvRememberData" data-persist-tv="true">
                            <label for="tvRememberData">Remember data for next time</label>
                        </div>
                        <div id="tvMessageBox" class="message-box"></div>
                        <button class="calculate-button" id="calculateTvBtn">Calculate Days</button>
                    </div>
                </div>
                <div class="results-right-side">
                    <div id="tvResults" class="results-section">
                        <h3>Time to Reach Target Volume</h3>
                        <hr class="results-divider">
                        <div class="grid-item days-needed">
                            <p class="result-label">Days Needed</p>
                            <p class="result-value large" id="tvDaysNeeded">0</p>
                        </div>
                        <div class="results-grid">
                            <div class="grid-item"><p class="result-label">Target Volume</p><p class="result-value" id="tvTargetResult">USDT 0.00</p></div>
                            <div class="grid-item right-align"><p class="result-label">Projected End Date</p><p class="result-value" id="tvEndDate">N/A</p></div>
                            <div class="grid-item"><p class="result-label">Initial Principal</p><p class="result-value" id="tvPrincipalResult">USDT 0.00</p></div>
                             <div class="grid-item right-align"><p class="result-label">Daily Interest Rate</p><p class="result-value" id="tvRateResult">0.0%</p></div>
                            <div class="grid-item"><p class="result-label">Total interest / earnings</p><p class="result-value orange" id="tvTotalEarnings">USDT 0.00</p></div>
                            <div class="grid-item right-align"><p class="result-label">Investment value</p><p class="result-value green" id="tvInvestmentValue">USDT 0.00</p></div>
                            <div class="grid-item" style="grid-column: 1 / -1; text-align: center; margin-top: 10px;"><p class="result-label">Percentage profit</p><p class="result-value orange" id="tvPercentageProfit">0.0%</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Embedded JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Global Elements & State ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const CALC_STORAGE_KEY = 'dailyCompoundCalcData_v3';
            const TV_STORAGE_KEY = 'tradingVolumeCalcData_v1';

            // --- Utility Functions ---
            const showMessage = (el, message) => {
                el.textContent = message;
                el.classList.add('show');
                setTimeout(() => el.classList.remove('show'), 3000);
            };
            const formatDate = date => date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            const formatDateForBreakdown = date => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = date.toLocaleString('en-US', { month: 'short' });
                const year = String(date.getFullYear()).slice(-2);
                return `${day} ${month} '${year}`;
            };
            const getTodayDateISO = () => new Date().toISOString().split('T')[0];
            
            // --- Tab Switching Logic ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const targetTab = document.getElementById(button.dataset.tab);
                    tabContents.forEach(content => content.classList.remove('active'));
                    if (targetTab) targetTab.classList.add('active');
                });
            });

            // ##################################
            // ### CALCULATIONS TAB LOGIC ###
            // ##################################
            const initCalculationsTab = () => {
                const tabNode = document.getElementById('calculationsTab');
                if (!tabNode) return;

                const principalInput = tabNode.querySelector('#principal');
                const interestRateSelect = tabNode.querySelector('#interestRate');
                const daysInput = tabNode.querySelector('#days');
                const calculateBtn = tabNode.querySelector('#calculateBtn');
                const rememberDataCheckbox = tabNode.querySelector('#rememberDataCheckbox');
                const startDateInput = tabNode.querySelector('#startDate');
                const currencyButtons = tabNode.querySelectorAll('#currencySelector .currency-button');
                const principalSymbol = tabNode.querySelector('#principalSymbol');
                const messageBox = tabNode.querySelector('#messageBox');
                const projectionHeading = tabNode.querySelector('#projectionHeading');
                const investmentValueSpan = tabNode.querySelector('#investmentValue');
                const totalEarningsSpan = tabNode.querySelector('#totalEarnings');
                const percentageProfitSpan = tabNode.querySelector('#percentageProfit');
                const totalDaysResultSpan = tabNode.querySelector('#totalDaysResult');
                const dailyEffectiveRateSpan = tabNode.querySelector('#dailyEffectiveRate');
                const endDateSpan = tabNode.querySelector('#endDate');
                const initialBalanceDateSpan = tabNode.querySelector('#initialBalanceDate');
                const initialBalanceSpan = tabNode.querySelector('#initialBalance');
                const totalTradingVolumeSpan = tabNode.querySelector('#totalTradingVolume');
                const tradingVolumeNoteSpan = tabNode.querySelector('#tradingVolumeNote');
                const toggleEarningsBreakdownBtn = tabNode.querySelector('#toggleEarningsBreakdownBtn');
                const earningsBreakdownContent = tabNode.querySelector('#dailyBreakdownContent');
                const toggleTradingVolumeBreakdownBtn = tabNode.querySelector('#toggleTradingVolumeBreakdownBtn');
                const tradingVolumeBreakdownContent = tabNode.querySelector('#tradingVolumeBreakdownContent');
                
                let isEarningsBreakdownExpanded = false;
                let isTradingVolumeBreakdownExpanded = false;

                const activateCurrencyButton = (symbolToActivate) => {
                    currencyButtons.forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.currencySymbol === symbolToActivate);
                        if (btn.dataset.currencySymbol === symbolToActivate) {
                            principalSymbol.textContent = btn.textContent;
                        }
                    });
                };

                const saveFormData = () => {
                    if (!rememberDataCheckbox.checked) {
                        localStorage.removeItem(CALC_STORAGE_KEY);
                        return;
                    }
                    const activeCurrency = tabNode.querySelector('#currencySelector .currency-button.active');
                    const data = {
                        principal: principalInput.value,
                        interestRate: interestRateSelect.value,
                        days: daysInput.value,
                        currency: activeCurrency ? activeCurrency.dataset.currencySymbol : 'USDT',
                        startDate: startDateInput.value,
                        remember: rememberDataCheckbox.checked,
                        isEarningsExpanded: isEarningsBreakdownExpanded,
                        isTradingVolumeExpanded: isTradingVolumeBreakdownExpanded
                    };
                    localStorage.setItem(CALC_STORAGE_KEY, JSON.stringify(data));
                };

                const loadFormData = () => {
                    const stored = localStorage.getItem(CALC_STORAGE_KEY);
                    const data = stored ? JSON.parse(stored) : {};
                    rememberDataCheckbox.checked = !!data.remember;

                    if (rememberDataCheckbox.checked) {
                        principalInput.value = data.principal || '1000';
                        interestRateSelect.value = data.interestRate || '1.3';
                        daysInput.value = data.days || '30';
                        startDateInput.value = data.startDate || getTodayDateISO();
                        activateCurrencyButton(data.currency || 'USDT');
                        isEarningsBreakdownExpanded = !!data.isEarningsExpanded;
                        isTradingVolumeBreakdownExpanded = !!data.isTradingVolumeExpanded;
                    } else {
                        principalInput.value = '1000';
                        interestRateSelect.value = '1.3';
                        daysInput.value = '30';
                        startDateInput.value = getTodayDateISO();
                        activateCurrencyButton('USDT');
                        isEarningsBreakdownExpanded = false;
                        isTradingVolumeBreakdownExpanded = false;
                    }
                    
                    earningsBreakdownContent.classList.toggle('expanded', isEarningsBreakdownExpanded);
                    toggleEarningsBreakdownBtn.classList.toggle('expanded', isEarningsBreakdownExpanded);
                    tradingVolumeBreakdownContent.classList.toggle('expanded', isTradingVolumeBreakdownExpanded);
                    toggleTradingVolumeBreakdownBtn.classList.toggle('expanded', isTradingVolumeBreakdownExpanded);
                    
                    calculateAndDisplay();
                };

                const renderBreakdown = (container, data, headers, rowRenderer, symbol) => {
                    container.innerHTML = '';
                    if (!data || data.length === 0) {
                        container.innerHTML = '<p class="no-data">Calculate first.</p>';
                        return;
                    }
                    const table = document.createElement('table');
                    table.className = 'breakdown-table';
                    const thead = table.createTHead();
                    const headerRow = thead.insertRow();
                    headers.forEach(h => {
                        const th = document.createElement('th');
                        th.textContent = h;
                        headerRow.appendChild(th);
                    });
                    const tbody = table.createTBody();
                    data.forEach(item => rowRenderer(tbody.insertRow(), item, symbol));
                    container.appendChild(table);
                };

                const renderEarningsRow = (row, item, symbol) => {
                    row.innerHTML = `
                        <td data-label="Date/Day" class="col-date-day">${item.date}<br>Day ${item.day}</td>
                        <td data-label="Earnings">${symbol} ${item.earnings.toFixed(2)}</td>
                        <td data-label="Total" class="col-total-earnings">${symbol} ${item.totalEarnings.toFixed(2)}</td>
                        <td data-label="Balance" class="col-balance">${symbol} ${item.balance.toFixed(2)}</td>`;
                };

                const renderTradingVolumeRow = (row, item, symbol) => {
                     row.innerHTML = `
                        <td data-label="Date/Day" class="col-date-day">${item.date}<br>Day ${item.day}</td>
                        <td data-label="Per Trade">${symbol} ${item.tradingValuePerTrade.toFixed(2)}</td>
                        <td data-label="Per Day" class="col-per-day">${symbol} ${item.tradingValuePerDay.toFixed(2)}</td>
                        <td data-label="Total Volume" class="col-total-volume">${symbol} ${item.totalTradingVolume.toFixed(2)}</td>`;
                };

                const calculateAndDisplay = () => {
                    const principal = parseFloat(principalInput.value);
                    const interestRate = parseFloat(interestRateSelect.value);
                    const days = parseInt(daysInput.value, 10);
                    const symbol = principalSymbol.textContent;

                    if (isNaN(principal) || principal <= 0 || isNaN(interestRate) || interestRate < 0 || isNaN(days) || days <= 0) {
                        return;
                    }
                    
                    const interestRateDecimal = interestRate / 100;
                    let currentAmount = principal;
                    let totalInterestEarned = 0;
                    const earningsData = [];
                    const startDate = new Date(startDateInput.value + 'T00:00:00');
                    for (let i = 0; i < days; i++) {
                        const interestForDay = currentAmount * interestRateDecimal;
                        totalInterestEarned += interestForDay;
                        currentAmount += interestForDay;
                        const loopDate = new Date(startDate);
                        loopDate.setDate(startDate.getDate() + i);
                        earningsData.push({ day: i + 1, date: formatDateForBreakdown(loopDate), earnings: interestForDay, totalEarnings: totalInterestEarned, balance: currentAmount });
                    }
                    const endDateObj = new Date(startDate);
                    endDateObj.setDate(startDate.getDate() + days - 1);
                    projectionHeading.textContent = `Projection for ${days} days`;
                    investmentValueSpan.textContent = `${symbol} ${currentAmount.toFixed(2)}`;
                    totalEarningsSpan.textContent = `${symbol} ${totalInterestEarned.toFixed(2)}`;
                    percentageProfitSpan.textContent = `${(totalInterestEarned / principal * 100).toFixed(1)}%`;
                    totalDaysResultSpan.textContent = days;
                    dailyEffectiveRateSpan.textContent = `${interestRate.toFixed(2)}%`;
                    endDateSpan.textContent = formatDate(endDateObj);
                    initialBalanceDateSpan.textContent = formatDate(startDate);
                    initialBalanceSpan.textContent = `${symbol} ${principal.toFixed(2)}`;
                    renderBreakdown(earningsBreakdownContent, earningsData, ['Date/Day', 'Earnings', 'Total', 'Balance'], renderEarningsRow, symbol);

                    // --- Trading Volume Calculation using Formula ---
                    const tradingSignalCount = Math.max(0, Math.round(interestRate / 0.65));
                    const v0_tv = 0.01 * principal * tradingSignalCount;
                    let totalAccumulatedVolume;
                    if (interestRateDecimal > 0) {
                        totalAccumulatedVolume = v0_tv * ( (Math.pow(1 + interestRateDecimal, days) - 1) / interestRateDecimal );
                    } else {
                        totalAccumulatedVolume = v0_tv * days;
                    }
                    totalTradingVolumeSpan.textContent = `${symbol} ${totalAccumulatedVolume.toFixed(2)}`;
                    tradingVolumeNoteSpan.innerHTML = `*Your capital is ${symbol} ${principal.toFixed(2)}<br>*Capital grows by ${interestRate}% daily.<br>*You have ${tradingSignalCount} trading signals.<br>*Trading volume is: (1% * Current capital) * Trading signals * Duration in days.`;
                    
                    // --- Trading Volume Breakdown (still needs loop) ---
                    let accumulatedTradingVolumeBreakdown = 0;
                    let currentCapitalForTV = principal;
                    const tradingVolumeData = [];
                    for (let i = 0; i < days; i++) {
                        const tradingValuePerTrade = 0.01 * currentCapitalForTV;
                        const tradingValuePerDay = tradingValuePerTrade * tradingSignalCount;
                        accumulatedTradingVolumeBreakdown += tradingValuePerDay;
                        const loopDate = new Date(startDate);
                        loopDate.setDate(startDate.getDate() + i);
                        tradingVolumeData.push({ day: i + 1, date: formatDateForBreakdown(loopDate), tradingValuePerTrade, tradingValuePerDay, totalTradingVolume: accumulatedTradingVolumeBreakdown });
                        currentCapitalForTV += (currentCapitalForTV * interestRateDecimal);
                    }
                    renderBreakdown(tradingVolumeBreakdownContent, tradingVolumeData, ['Date/Day', 'Per Trade', 'Per Day', 'Total Volume'], renderTradingVolumeRow, symbol);

                    saveFormData();
                };

                currencyButtons.forEach(button => button.addEventListener('click', () => {
                    activateCurrencyButton(button.dataset.currencySymbol);
                    calculateAndDisplay();
                }));
                [principalInput, interestRateSelect, daysInput, startDateInput, rememberDataCheckbox].forEach(el => {
                    el.addEventListener('change', calculateAndDisplay);
                    el.addEventListener('input', calculateAndDisplay);
                });
                calculateBtn.addEventListener('click', calculateAndDisplay);
                toggleEarningsBreakdownBtn.addEventListener('click', () => {
                    isEarningsBreakdownExpanded = !isEarningsBreakdownExpanded;
                    earningsBreakdownContent.classList.toggle('expanded', isEarningsBreakdownExpanded);
                    toggleEarningsBreakdownBtn.classList.toggle('expanded', isEarningsBreakdownExpanded);
                    saveFormData();
                });
                toggleTradingVolumeBreakdownBtn.addEventListener('click', () => {
                    isTradingVolumeBreakdownExpanded = !isTradingVolumeBreakdownExpanded;
                    tradingVolumeBreakdownContent.classList.toggle('expanded', isTradingVolumeBreakdownExpanded);
                    toggleTradingVolumeBreakdownBtn.classList.toggle('expanded', isTradingVolumeBreakdownExpanded);
                    saveFormData();
                });

                loadFormData();
            };

            // ##################################
            // ### TRADING VOLUME TAB LOGIC ###
            // ##################################
            const initTradingVolumeTab = () => {
                const tabNode = document.getElementById('tradingVolumeTab');
                if (!tabNode) return;

                const tv = {
                    principal: tabNode.querySelector('#tvPrincipal'),
                    interestRate: tabNode.querySelector('#tvInterestRate'),
                    targetVolume: tabNode.querySelector('#tvTargetVolume'),
                    startDate: tabNode.querySelector('#tvStartDate'),
                    rememberData: tabNode.querySelector('#tvRememberData'),
                    calculateBtn: tabNode.querySelector('#calculateTvBtn'),
                    messageBox: tabNode.querySelector('#tvMessageBox'),
                    currencyButtons: tabNode.querySelectorAll('#tvCurrencySelector .currency-button'),
                    principalSymbol: tabNode.querySelector('#tvPrincipalSymbol'),
                    targetVolumeSymbol: tabNode.querySelector('#tvTargetVolumeSymbol'),
                    daysNeeded: tabNode.querySelector('#tvDaysNeeded'),
                    targetResult: tabNode.querySelector('#tvTargetResult'),
                    endDate: tabNode.querySelector('#tvEndDate'),
                    principalResult: tabNode.querySelector('#tvPrincipalResult'),
                    rateResult: tabNode.querySelector('#tvRateResult'),
                    totalEarnings: tabNode.querySelector('#tvTotalEarnings'),
                    investmentValue: tabNode.querySelector('#tvInvestmentValue'),
                    percentageProfit: tabNode.querySelector('#tvPercentageProfit')
                };

                const activateTvCurrencyButton = (symbol) => {
                    tv.currencyButtons.forEach(btn => {
                        const isActive = btn.dataset.currencySymbol === symbol;
                        btn.classList.toggle('active', isActive);
                        if (isActive) {
                            tv.principalSymbol.textContent = btn.textContent;
                            tv.targetVolumeSymbol.textContent = btn.textContent;
                        }
                    });
                };

                const saveTvData = () => {
                    if (!tv.rememberData.checked) {
                        localStorage.removeItem(TV_STORAGE_KEY);
                        return;
                    }
                    const activeCurrency = tabNode.querySelector('#tvCurrencySelector .currency-button.active');
                    const data = {
                        principal: tv.principal.value,
                        interestRate: tv.interestRate.value,
                        targetVolume: tv.targetVolume.value,
                        currency: activeCurrency ? activeCurrency.dataset.currencySymbol : 'USDT',
                        startDate: tv.startDate.value,
                        remember: tv.rememberData.checked,
                    };
                    localStorage.setItem(TV_STORAGE_KEY, JSON.stringify(data));
                };

                const loadTvData = () => {
                    const stored = localStorage.getItem(TV_STORAGE_KEY);
                    const data = stored ? JSON.parse(stored) : {};
                    tv.rememberData.checked = !!data.remember;

                    if (tv.rememberData.checked) {
                        tv.principal.value = data.principal || '1000';
                        tv.interestRate.value = data.interestRate || '1.3';
                        tv.targetVolume.value = data.targetVolume || '1000';
                        tv.startDate.value = data.startDate || getTodayDateISO();
                        activateTvCurrencyButton(data.currency || 'USDT');
                    } else {
                        tv.principal.value = '1000';
                        tv.interestRate.value = '1.3';
                        tv.targetVolume.value = '1000';
                        tv.startDate.value = getTodayDateISO();
                        activateTvCurrencyButton('USDT');
                    }
                    calculateDaysForVolume();
                };

                const calculateDaysForVolume = () => {
                    const principal = parseFloat(tv.principal.value);
                    const interestRate = parseFloat(tv.interestRate.value);
                    const targetVolume = parseFloat(tv.targetVolume.value);
                    const symbol = tv.principalSymbol.textContent;

                    if (isNaN(principal) || principal <= 0 || isNaN(interestRate) || interestRate < 0 || isNaN(targetVolume) || targetVolume <= 0) {
                        return;
                    }

                    const interestRateDecimal = interestRate / 100;
                    const tradingSignalCount = Math.max(0, Math.round(interestRate / 0.65));
                    
                    if (tradingSignalCount === 0) {
                        showMessage(tv.messageBox, "Interest rate is too low to generate trading signals.");
                        tv.daysNeeded.textContent = '∞';
                        return;
                    }

                    const v0_tv = 0.01 * principal * tradingSignalCount;
                    if (v0_tv <= 0) {
                        tv.daysNeeded.textContent = '∞';
                        return;
                    }

                    let days;
                    if (interestRateDecimal > 0) {
                        const daysFloat = Math.log((targetVolume * interestRateDecimal / v0_tv) + 1) / Math.log(1 + interestRateDecimal);
                        days = Math.ceil(daysFloat);
                    } else {
                        days = Math.ceil(targetVolume / v0_tv);
                    }

                    if (!isFinite(days) || days <= 0) {
                        days = 0;
                    }
                    
                    // Recalculate final values based on the determined number of days
                    const finalInvestmentValue = principal * Math.pow(1 + interestRateDecimal, days);
                    const totalInterestEarned = finalInvestmentValue - principal;
                    const percentageProfit = principal > 0 ? (totalInterestEarned / principal) * 100 : 0;

                    tv.daysNeeded.textContent = days > 10000 ? '> 10k' : days;
                    tv.targetResult.textContent = `${symbol} ${targetVolume.toFixed(2)}`;
                    tv.principalResult.textContent = `${symbol} ${principal.toFixed(2)}`;
                    tv.rateResult.textContent = `${interestRate.toFixed(2)}%`;
                    tv.totalEarnings.textContent = `${symbol} ${totalInterestEarned.toFixed(2)}`;
                    tv.investmentValue.textContent = `${symbol} ${finalInvestmentValue.toFixed(2)}`;
                    tv.percentageProfit.textContent = `${percentageProfit.toFixed(1)}%`;

                    if (days > 0 && days <= 10000) {
                        const startDate = new Date(tv.startDate.value + 'T00:00:00');
                        const endDateObj = new Date(startDate);
                        endDateObj.setDate(startDate.getDate() + days -1);
                        tv.endDate.textContent = formatDate(endDateObj);
                    } else {
                        tv.endDate.textContent = 'N/A';
                    }
                    saveTvData();
                };
                
                tv.currencyButtons.forEach(el => {
                    el.addEventListener('click', () => {
                        activateTvCurrencyButton(el.dataset.currencySymbol);
                        calculateDaysForVolume();
                    });
                });
                
                tv.principal.addEventListener('input', () => {
                    tv.targetVolume.value = tv.principal.value;
                });

                tabNode.querySelectorAll('[data-persist-tv="true"]').forEach(el => {
                     el.addEventListener('change', calculateDaysForVolume);
                     el.addEventListener('input', calculateDaysForVolume);
                });

                tv.calculateBtn.addEventListener('click', calculateDaysForVolume);
                
                loadTvData();
            };

            // --- Initial Load ---
            initCalculationsTab();
            initTradingVolumeTab();
        });
    </script>
</body>
</html>
